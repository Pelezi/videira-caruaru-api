generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Matrix {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domains       MatrixDomain[]
  members       MemberMatrix[]
  celulas       Celula[]
  roles         Role[]
  ministries    Ministry[]
  winnerPaths   WinnerPath[]
  redes         Rede[]
  discipulados  Discipulado[]
  reports       Report[]
  apiKeys       ApiKey[]
}

model MatrixDomain {
  id        Int      @id @default(autoincrement())
  domain    String   @unique
  matrixId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  matrix Matrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@index([matrixId])
}

model MemberMatrix {
  id       Int @id @default(autoincrement())
  memberId Int
  matrixId Int

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  matrix Matrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@unique([memberId, matrixId])
  @@index([memberId])
  @@index([matrixId])
}

model Celula {
  id                 Int      @id @default(autoincrement())
  name               String
  matrixId           Int
  leaderMemberId     Int
  viceLeaderMemberId Int?
  discipuladoId      Int
  weekday            Int?
  time               String?
  
  // Address fields
  country      String?       @default("Brasil")
  zipCode      String?
  street       String?
  streetNumber String?
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  members Member[]
  reports Report[]

  matrix      Matrix      @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  discipulado Discipulado @relation(fields: [discipuladoId], references: [id])
  leader      Member      @relation("CelulaLeader", fields: [leaderMemberId], references: [id], onDelete: NoAction)
  viceLeader  Member?      @relation("CelulaViceLeader", fields: [viceLeaderMemberId], references: [id], onDelete: NoAction)

  @@unique([name, matrixId])
  @@index([matrixId])
  @@index([discipuladoId])
  @@index([leaderMemberId])
  @@index([viceLeaderMemberId])
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String
  matrixId  Int
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // To do: Permiss√µes de tesoureiro, gerenciar landing page, gerenciar revistas, etc.

  matrix  Matrix       @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members MemberRole[]

  @@unique([name, matrixId])
  @@index([matrixId])
}

model Ministry {
  id        Int          @id @default(autoincrement())
  name      String
  matrixId  Int
  type      MinistryType @default(MEMBER)
  priority  Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  matrix  Matrix   @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members Member[]

  @@unique([name, matrixId])
  @@index([matrixId])
}

model WinnerPath {
  id        Int      @id @default(autoincrement())
  name      String
  matrixId  Int
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  matrix  Matrix   @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members Member[]

  @@unique([name, matrixId])
  @@index([matrixId])
}

model Member {
  id          Int         @id @default(autoincrement())
  
  // User/Auth fields (from old User model)
  email       String?      @unique
  password    String?
  phone       String?
  hasDefaultPassword Boolean?
  inviteSent  Boolean      @default(false)
  hasLoggedIn Boolean      @default(false)
  
  // Member info fields (from old Member model)
  name          String
  celulaId      Int?
  isActive      Boolean       @default(true)
  maritalStatus MaritalStatus @default(SINGLE)
  
  // Personal info
  photoUrl      String?
  gender        Gender?
  isBaptized    Boolean       @default(false)
  baptismDate   DateTime?
  birthDate     DateTime?
  registerDate  DateTime?
  spouseId      Int?          @unique
  
  // Church info
  ministryPositionId  Int
  winnerPathId        Int?
  canBeHost           Boolean    @default(false)
  
  // Address
  country      String?       @default("Brasil")
  zipCode      String?
  street       String?
  streetNumber String?
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  // Access
  hasSystemAccess  Boolean    @default(false)
  isOwner          Boolean    @default(false)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  attendances      ReportAttendance[]
  redes            Rede[]
  discipulados     Discipulado[]
  ledCelulas       Celula[]      @relation("CelulaLeader")
  viceLedCelulas   Celula[]      @relation("CelulaViceLeader")
  celula           Celula?       @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  ministryPosition Ministry     @relation(fields: [ministryPositionId], references: [id], onDelete: NoAction)
  winnerPath       WinnerPath?   @relation(fields: [winnerPathId], references: [id], onDelete: NoAction)
  spouse           Member?       @relation("MemberSpouse", fields: [spouseId], references: [id], onDelete: NoAction)
  spouseOf         Member?       @relation("MemberSpouse")
  roles            MemberRole[]
  refreshTokens    RefreshToken[]
  createdApiKeys   ApiKey[]
  matrices         MemberMatrix[]

  @@index([celulaId])
  @@index([ministryPositionId])
  @@index([winnerPathId])
  @@index([spouseId])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  COHABITATING
  MARRIED
  DIVORCED
  WIDOWED
}

enum MinistryType {
  PRESIDENT_PASTOR
  PASTOR
  DISCIPULADOR
  LEADER
  LEADER_IN_TRAINING
  MEMBER
  REGULAR_ATTENDEE
  VISITOR
}

model Rede {
  id           Int      @id @default(autoincrement())
  name         String
  matrixId     Int
  pastorMemberId Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  matrix       Matrix          @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  discipulados Discipulado[]
  pastor       Member? @relation(fields: [pastorMemberId], references: [id], onDelete: NoAction)

  @@unique([name, matrixId])
  @@index([matrixId])
}

model Discipulado {
  id                 Int      @id @default(autoincrement())
  matrixId           Int
  redeId             Int
  discipuladorMemberId Int
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  celulas Celula[]

  matrix       Matrix @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  rede         Rede   @relation(fields: [redeId], references: [id], onDelete: NoAction)
  discipulador Member @relation(fields: [discipuladorMemberId], references: [id], onDelete: NoAction)

  @@index([matrixId])
  @@index([redeId])
  @@index([discipuladorMemberId])
}

model Report {
  id        Int      @id @default(autoincrement())
  matrixId  Int
  createdAt DateTime @default(now())
  celulaId  Int

  matrix      Matrix             @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  celula      Celula             @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([matrixId])
  @@index([celulaId])
}

model ReportAttendance {
  id       Int @id @default(autoincrement())
  reportId Int
  memberId Int

  report Report @relation(fields: [reportId], references: [id], onDelete: NoAction)
  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)

  @@unique([reportId, memberId])
  @@index([reportId])
  @@index([memberId])
}

model MemberRole {
  id       Int @id @default(autoincrement())
  memberId Int
  roleId   Int

  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: NoAction)

  @@unique([memberId, roleId])
  @@index([memberId])
  @@index([roleId])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  memberId  Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isRevoked Boolean  @default(false)

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([token])
}

model ApiKey {
  id          Int      @id @default(autoincrement())
  name        String
  matrixId    Int
  key         String   @unique
  isActive    Boolean  @default(true)
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastUsedAt  DateTime?

  matrix    Matrix @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  createdBy Member @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([matrixId])
  @@index([key])
  @@index([createdById])
}
