generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Celula {
  id                 Int      @id @default(autoincrement())
  name               String   @unique
  leaderMemberId     Int
  viceLeaderMemberId Int?
  discipuladoId      Int
  weekday            Int?
  time               String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  members Member[]
  reports Report[]

  discipulado Discipulado @relation(fields: [discipuladoId], references: [id])
  leader      Member      @relation("CelulaLeader", fields: [leaderMemberId], references: [id], onDelete: NoAction)
  viceLeader  Member?      @relation("CelulaViceLeader", fields: [viceLeaderMemberId], references: [id], onDelete: NoAction)

  @@index([discipuladoId])
  @@index([leaderMemberId])
  @@index([viceLeaderMemberId])
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // To do: Permiss√µes de tesoureiro, gerenciar landing page, gerenciar revistas, etc.

  members MemberRole[]
}

model Ministry {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  type      MinistryType @default(MEMBER)
  priority  Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  members Member[]
}

model WinnerPath {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Member[]
}

model Member {
  id          Int         @id @default(autoincrement())
  
  // User/Auth fields (from old User model)
  email       String?      @unique
  password    String?
  phone       String?
  hasDefaultPassword Boolean  @default(true)
  
  // Member info fields (from old Member model)
  name          String
  celulaId      Int?
  isActive      Boolean       @default(true)
  maritalStatus MaritalStatus @default(SINGLE)
  
  // Personal info
  photoUrl      String?
  gender        Gender?
  isBaptized    Boolean       @default(false)
  baptismDate   DateTime?
  birthDate     DateTime?
  registerDate  DateTime?
  spouseId      Int?          @unique
  
  // Church info
  ministryPositionId  Int
  winnerPathId        Int?
  canBeHost           Boolean    @default(false)
  
  // Address
  country      String?       @default("Brasil")
  zipCode      String?
  street       String?
  streetNumber String?
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  // Access
  hasSystemAccess  Boolean    @default(false)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  attendances      ReportAttendance[]
  redes            Rede[]
  discipulados     Discipulado[]
  ledCelulas       Celula[]      @relation("CelulaLeader")
  viceLedCelulas   Celula[]      @relation("CelulaViceLeader")
  celula           Celula?       @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  ministryPosition Ministry     @relation(fields: [ministryPositionId], references: [id], onDelete: NoAction)
  winnerPath       WinnerPath?   @relation(fields: [winnerPathId], references: [id], onDelete: NoAction)
  spouse           Member?       @relation("MemberSpouse", fields: [spouseId], references: [id], onDelete: NoAction)
  spouseOf         Member?       @relation("MemberSpouse")
  roles            MemberRole[]

  @@index([celulaId])
  @@index([ministryPositionId])
  @@index([winnerPathId])
  @@index([spouseId])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  COHABITATING
  MARRIED
  DIVORCED
  WIDOWED
}

enum MinistryType {
  PRESIDENT_PASTOR
  PASTOR
  DISCIPULADOR
  LEADER
  LEADER_IN_TRAINING
  MEMBER
  REGULAR_ATTENDEE
  VISITOR
}

model Rede {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  pastorMemberId Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  discipulados Discipulado[]

  pastor Member? @relation(fields: [pastorMemberId], references: [id], onDelete: NoAction)
}

model Discipulado {
  id                 Int      @id @default(autoincrement())
  redeId             Int
  discipuladorMemberId Int
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  celulas Celula[]

  rede         Rede   @relation(fields: [redeId], references: [id], onDelete: NoAction)
  discipulador Member @relation(fields: [discipuladorMemberId], references: [id], onDelete: NoAction)

  @@index([redeId])
  @@index([discipuladorMemberId])
}

model Report {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  celulaId  Int

  celula      Celula             @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([celulaId])
}

model ReportAttendance {
  id       Int @id @default(autoincrement())
  reportId Int
  memberId Int

  report Report @relation(fields: [reportId], references: [id], onDelete: NoAction)
  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)

  @@unique([reportId, memberId])
  @@index([reportId])
  @@index([memberId])
}

model MemberRole {
  id       Int @id @default(autoincrement())
  memberId Int
  roleId   Int

  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: NoAction)

  @@unique([memberId, roleId])
  @@index([memberId])
  @@index([roleId])
}
