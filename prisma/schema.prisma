generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  phoneNumber String?
  firstAccess Boolean  @default(true)
  locale      String   @default("en")
  timezone    String   @default("UTC")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  budgets           Budget[]
  categories        Category[]
  subcategories     Subcategory[]
  transactions      Transaction[]
  ownedGroups       Group[]            @relation("GroupOwner")
  groupMemberships  GroupMember[]
  receivedInvitations GroupInvitation[] @relation("UserInvitations")
  sentInvitations   GroupInvitation[]  @relation("SentInvitations")
  notifications     Notification[]
  accounts            Account[]
}

model Category {
  id          Int          @id @default(autoincrement())
  userId      Int
  groupId     Int?
  name        String
  description String?
  type        CategoryType @default(EXPENSE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: NoAction)
  group         Group?        @relation(fields: [groupId], references: [id], onDelete: NoAction)
  subcategories Subcategory[]

  @@index([userId])
  @@index([groupId])
  @@index([type])
}

model Subcategory {
  id          Int          @id @default(autoincrement())
  userId      Int
  groupId     Int?
  categoryId  Int
  name        String
  description String?
  type        CategoryType @default(EXPENSE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: NoAction)
  group        Group?        @relation(fields: [groupId], references: [id], onDelete: NoAction)
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: NoAction)
  budgets      Budget[]
  transactions Transaction[]
  // Accounts that reference this subcategory (used by PREPAID accounts)
  accounts Account[]

  @@index([userId])
  @@index([groupId])
  @@index([categoryId])
  @@index([type])
}

model Budget {
  id            Int          @id @default(autoincrement())
  userId        Int
  groupId       Int?
  amount        Decimal      @db.Decimal(10, 2)
  type          CategoryType @default(EXPENSE)
  month         Int
  year          Int
  subcategoryId Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: NoAction)
  group       Group?      @relation(fields: [groupId], references: [id], onDelete: NoAction)
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: NoAction)

  @@index([userId])
  @@index([groupId])
  @@index([subcategoryId])
  @@index([type])
}

model Transaction {
  id            Int          @id @default(autoincrement())
  userId        Int
  groupId       Int?
  subcategoryId Int?
  accountId     Int
  title         String?
  amount        Decimal  @db.Decimal(10, 2)
  description   String?
  date          DateTime
  type          CategoryType @default(EXPENSE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  toAccountId Int?

  user        User        @relation(fields: [userId], references: [id], onDelete: NoAction)
  group       Group?      @relation(fields: [groupId], references: [id], onDelete: NoAction)
  subcategory Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: NoAction)
  account     Account     @relation(fields: [accountId], references: [id], onDelete: NoAction)
  accountTo   Account?    @relation("TransactionToAccount", fields: [toAccountId], references: [id], onDelete: NoAction)

  @@index([userId])
  @@index([groupId])
  @@index([subcategoryId])
  @@index([accountId])
  @@index([toAccountId])
  @@index([date])
  @@index([type])
}

enum CategoryType {
  EXPENSE
  INCOME
  TRANSFER
  UPDATE
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner         User              @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: NoAction)
  members       GroupMember[]
  roles         GroupRole[]
  budgets       Budget[]
  categories    Category[]
  subcategories Subcategory[]
  transactions  Transaction[]
  invitations   GroupInvitation[]
  accounts      Account[]

  @@index([ownerId])
}

model GroupRole {
  id          Int      @id @default(autoincrement())
  groupId     Int
  name        String
  description String?
  
  // Permission flags
  canViewTransactions       Boolean @default(true)
  canManageOwnTransactions  Boolean @default(false)  // Manage only own transactions
  canManageGroupTransactions Boolean @default(false) // Manage all group transactions
  canViewCategories         Boolean @default(true)
  canManageCategories       Boolean @default(false)
  canViewSubcategories      Boolean @default(true)
  canManageSubcategories    Boolean @default(false)
  canViewBudgets            Boolean @default(true)
  canManageBudgets          Boolean @default(false)
  canViewAccounts           Boolean @default(true)
  canManageOwnAccounts      Boolean @default(false)  // Manage only own accounts
  canManageGroupAccounts    Boolean @default(false)  // Manage all group accounts
  canManageGroup            Boolean @default(false)  // Manage members, roles, and group settings
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group       Group             @relation(fields: [groupId], references: [id], onDelete: NoAction)
  members     GroupMember[]
  invitations GroupInvitation[]

  @@unique([groupId, name])
  @@index([groupId])
}

model GroupMember {
  id        Int      @id @default(autoincrement())
  groupId   Int
  userId    Int
  roleId    Int
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  group Group     @relation(fields: [groupId], references: [id], onDelete: NoAction)
  user  User      @relation(fields: [userId], references: [id], onDelete: NoAction)
  role  GroupRole @relation(fields: [roleId], references: [id], onDelete: NoAction)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([roleId])
}

model GroupInvitation {
  id        Int      @id @default(autoincrement())
  groupId   Int
  userId    Int      // User being invited
  invitedBy Int      // User who sent the invitation
  roleId    Int
  status    InvitationStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group     @relation(fields: [groupId], references: [id], onDelete: NoAction)
  user      User      @relation("UserInvitations", fields: [userId], references: [id], onDelete: NoAction)
  inviter   User      @relation("SentInvitations", fields: [invitedBy], references: [id], onDelete: NoAction)
  role      GroupRole @relation(fields: [roleId], references: [id], onDelete: NoAction)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              // User who receives the notification
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json?            // Additional data (groupId, transactionId, etc.)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: NoAction)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  GROUP_INVITATION
  GROUP_MEMBER_JOINED
  GROUP_MEMBER_LEFT
  TRANSACTION_CREATED
  TRANSACTION_UPDATED
  TRANSACTION_DELETED
  CATEGORY_CREATED
  CATEGORY_UPDATED
  CATEGORY_DELETED
  SUBCATEGORY_CREATED
  SUBCATEGORY_UPDATED
  SUBCATEGORY_DELETED
  BUDGET_CREATED
  BUDGET_UPDATED
  BUDGET_DELETED
  GROUP_UPDATED
}

model Account {
  id          Int         @id @default(autoincrement())
  userId      Int
  groupId     Int?
  name        String
  type        AccountType
  // Optional link to a subcategory (used for prepaid accounts)
  subcategoryId Int?
  creditDueDay Int?
  creditClosingDay Int?
  debitMethod DebitMethod?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: NoAction)
  group    Group?           @relation(fields: [groupId], references: [id], onDelete: NoAction)
  subcategory Subcategory?  @relation(fields: [subcategoryId], references: [id], onDelete: NoAction)
  balances AccountBalance[]
  transactions Transaction[]
  transactionsTo Transaction[] @relation("TransactionToAccount")

  @@index([userId])
  @@index([groupId])
  @@index([subcategoryId])
  @@index([type])
}

enum AccountType {
  CREDIT
  CASH
  PREPAID
}

enum DebitMethod {
  INVOICE
  PER_PURCHASE
}

model AccountBalance {
  id        Int      @id @default(autoincrement())
  accountId Int
  amount    Decimal  @db.Decimal(10, 2)
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: NoAction)

  @@index([accountId])
  @@index([date])
}
